# Supabaseデータベーススキーマ

## 📄 スキーマファイル

### complete_schema.sql
完全なデータベーススキーマを含む統合ファイルです。

**含まれる内容：**
- ✅ PostGIS拡張機能
- ✅ 全テーブル定義（14テーブル）
- ✅ RLS（行レベルセキュリティ）ポリシー（47ポリシー）
- ✅ ストアドファンクション（14関数）
- ✅ トリガー
- ✅ ビュー
- ✅ インデックス
- ✅ 権限設定

## 🚀 使用方法

### 新規データベース作成
```sql
-- Supabase SQL Editorで実行
\i complete_schema.sql
```

### 主要なテーブル

#### 場所・イベント管理
- `venues` - 会場（GPS位置情報付き）
- `events` - イベント
- `shifts` - シフト

#### スタッフ管理
- `staff` - スタッフ情報
- `staff_skills` - 4スキル（PA、音源再生、照明、バックヤード）
- `staff_schedules` - 週間スケジュール

#### 出退勤管理
- `assignments` - シフト割り当て
- `attendances` - GPS検証付き出退勤記録
- `qr_tokens` - 日次QRトークン

#### セキュリティ
- `user_roles` - ユーザー権限
- `audit_logs` - 監査ログ

## 🔐 セキュリティ機能

### RLSポリシー
- 管理者専用操作
- マネージャー権限
- スタッフ自己管理
- データ分離

### GPS検証
- 会場から300m以内での打刻制限
- PostGISによる高精度計算

### QRトークン
- 日次生成
- 自動有効期限管理

## 📝 注意事項

1. **Storage Bucket**
   - `att-photos`バケットは手動作成が必要
   - Supabaseダッシュボードから設定

2. **環境変数**
   - 必要な環境変数は`.env.example`参照

3. **初期データ**
   - テストデータは別途用意

## 🔄 更新履歴

- **2024-09-23**: 統合スキーマファイル作成
  - 個別マイグレーションファイルから統合
  - RLSポリシー完全対応
  - 全機能実装済み