# タイムゾーン実装ガイド

## 概要

HAASシステムにおける日本時間（JST）とUTC間の変換処理の実装ガイドです。

## 基本方針

1. **データベース**: UTC保存
2. **API通信**: ISO 8601形式
3. **表示**: JST変換
4. **入力**: JSTで受け取りUTCに変換

## ユーティリティ関数

`lib/utils/date.ts` で提供される主要関数：

### 現在時刻取得
```typescript
import { getCurrentJST } from '@/lib/utils/date'

// 現在時刻（JST）を取得
const now = getCurrentJST()           // "2024-09-23 15:30"
const today = getCurrentJST('DATE')   // "2024-09-23"
const time = getCurrentJST('TIME')    // "15:30"
```

### UTC → JST変換
```typescript
import { parseToJST, formatToJST } from '@/lib/utils/date'

// Supabaseから取得したUTC時刻
const utcString = "2024-09-23T06:00:00Z"

// Dateオブジェクトに変換
const jstDate = parseToJST(utcString)

// 表示用にフォーマット
const display = formatToJST(utcString)              // "2024-09-23 15:00"
const dateOnly = formatToJST(utcString, {
  format: 'DATE_JP'
})  // "2024年09月23日"
```

### JST → UTC変換
```typescript
import { toSupabaseTimestamp } from '@/lib/utils/date'

// 現在時刻をUTCでSupabaseに保存
const timestamp = toSupabaseTimestamp()  // "2024-09-23T06:00:00.000Z"

// JST文字列をUTCに変換
const jstInput = "2024-09-23 15:00"
const utc = toSupabaseTimestamp(jstInput)  // "2024-09-23T06:00:00.000Z"
```

## 実装例

### APIエンドポイントでの使用

```typescript
// app/api/attendance/punch/route.ts
import { getCurrentJST, toSupabaseTimestamp } from '@/lib/utils/date'

export async function POST(req: NextRequest) {
  // 今日の日付（JST基準）
  const today = getCurrentJST('DATE')

  // シフト検索
  const { data: shift } = await supabase
    .from('shifts')
    .select('*')
    .gte('start_at', `${today}T00:00:00`)
    .lte('start_at', `${today}T23:59:59`)

  // 出勤記録作成（UTC保存）
  const { data } = await supabase
    .from('attendances')
    .insert({
      check_in_at: toSupabaseTimestamp(),  // 現在時刻をUTCで保存
      // ...
    })
}
```

### コンポーネントでの表示

```tsx
// components/AttendanceCard.tsx
import { formatToJST } from '@/lib/utils/date'

export function AttendanceCard({ attendance }) {
  return (
    <div>
      <p>出勤: {formatToJST(attendance.check_in_at)}</p>
      <p>退勤: {formatToJST(attendance.check_out_at, {
        fallback: '未退勤'
      })}</p>
    </div>
  )
}
```

### フォーム入力の処理

```tsx
// components/ShiftForm.tsx
import { toSupabaseTimestamp } from '@/lib/utils/date'

function handleSubmit(data) {
  // フォームからJST時刻を受け取る
  const jstDateTime = `${data.date} ${data.time}`  // "2024-09-23 09:00"

  // UTCに変換してAPIに送信
  const payload = {
    start_at: toSupabaseTimestamp(jstDateTime),
    // ...
  }

  await fetch('/api/shifts', {
    method: 'POST',
    body: JSON.stringify(payload)
  })
}
```

## フォーマットパターン

利用可能なフォーマット定数：

```typescript
DATE_FORMATS = {
  // 日付のみ
  DATE: 'yyyy-MM-dd',              // "2024-09-23"
  DATE_JP: 'yyyy年MM月dd日',        // "2024年09月23日"
  DATE_SLASH: 'yyyy/MM/dd',        // "2024/09/23"

  // 時刻のみ
  TIME: 'HH:mm',                   // "15:30"
  TIME_WITH_SEC: 'HH:mm:ss',       // "15:30:45"

  // 日付と時刻
  DATETIME: 'yyyy-MM-dd HH:mm',    // "2024-09-23 15:30"
  DATETIME_JP: 'yyyy年MM月dd日 HH:mm', // "2024年09月23日 15:30"

  // ISO形式
  ISO: "yyyy-MM-dd'T'HH:mm:ssXXX", // RFC3339形式
}
```

## ヘルパー関数

### 勤務時間計算

```typescript
import { calculateWorkHours } from '@/lib/utils/date'

// 勤務時間を計算
const hours = calculateWorkHours(
  attendance.check_in_at,
  attendance.check_out_at
)  // "8.5"

const hoursJP = calculateWorkHours(
  attendance.check_in_at,
  attendance.check_out_at,
  'japanese'
)  // "8時間30分"
```

### 相対時間表示

```typescript
import { getRelativeTime, isToday, isPast } from '@/lib/utils/date'

// 相対時間
getRelativeTime('2024-09-23T06:00:00Z')  // "2時間前"

// 日付判定
isToday('2024-09-23T06:00:00Z')          // true/false
isPast('2024-09-23T06:00:00Z')           // true/false
```

## 注意事項

### 1. time型カラムの扱い

PostgreSQLの`time`型は日付情報を持たないため、特別な処理が必要：

```typescript
import { formatTime } from '@/lib/utils/date'

// "15:30:00" → "15:30"
const displayTime = formatTime(shift.default_start_time)
```

### 2. Supabaseのタイムスタンプ

Supabaseは自動的にタイムゾーン変換を行う場合があるため：

```typescript
// 常にtoSupabaseTimestamp()を使用してUTC保存
const data = {
  created_at: toSupabaseTimestamp(),  // 推奨
  // created_at: new Date().toISOString()  // 非推奨
}
```

### 3. クライアント側の処理

SSRとクライアントでタイムゾーンが異なる可能性：

```typescript
// サーバー側でJST変換してからクライアントに渡す
export async function getServerSideProps() {
  const data = await fetchData()
  return {
    props: {
      // サーバー側で変換
      formattedDate: formatToJST(data.created_at)
    }
  }
}
```

## テスト

```typescript
// __tests__/unit/utils/date.test.ts
import { parseToJST, formatToJST } from '@/lib/utils/date'

describe('Timezone conversion', () => {
  it('should convert UTC to JST correctly', () => {
    const utc = '2024-01-01T00:00:00Z'
    const jst = formatToJST(utc, { format: 'DATETIME' })
    expect(jst).toBe('2024-01-01 09:00')  // +9時間
  })

  it('should handle DST correctly', () => {
    // 日本はDSTなし
    const summer = '2024-07-01T00:00:00Z'
    const winter = '2024-01-01T00:00:00Z'

    const summerJST = parseToJST(summer)
    const winterJST = parseToJST(winter)

    // 両方とも+9時間
    expect(summerJST.getHours()).toBe(9)
    expect(winterJST.getHours()).toBe(9)
  })
})
```

## トラブルシューティング

### 問題: 日付が1日ずれる

原因：UTC→JST変換忘れ

```typescript
// ❌ 間違い
const today = new Date().toISOString().split('T')[0]

// ✅ 正しい
const today = getCurrentJST('DATE')
```

### 問題: 時刻が9時間ずれる

原因：JST時刻をそのまま保存

```typescript
// ❌ 間違い
const now = new Date()  // ブラウザのローカル時刻

// ✅ 正しい
const now = toSupabaseTimestamp()  // UTC変換済み
```

### 問題: サーバーとクライアントで表示が異なる

原因：クライアント側でのタイムゾーン処理

```typescript
// ✅ サーバー側で変換してから渡す
const Component = ({ dateJST }) => {
  return <div>{dateJST}</div>  // すでにJST変換済み
}
```