# HAASドキュメント

## 📚 ドキュメント一覧

### システム全般
- [システム概要](./システム概要.md) - プロジェクト全体の概要と機能説明
- [データベース設計](./データベース設計.md) - テーブル構成とスキーマ詳細

### 開発者向け
- [APIリファレンス](./APIリファレンス.md) - REST APIエンドポイント仕様
- [タイムゾーン実装ガイド](./タイムゾーン実装ガイド.md) - JST/UTC変換の実装方法

### MCP（AI支援開発）
- [MCPセットアップガイド](./MCP_セットアップガイド.md) - Claude Desktop統合設定
- [MCPクイックリファレンス](./MCP_クイックリファレンス.md) - MCPコマンド一覧

### その他
- [開発用パスワード](./dev_passwords.md) - 開発環境のテストアカウント

## 🚀 クイックスタート

### 開発者向け

1. **プロジェクト初心者の方** → [システムアーキテクチャ](./SYSTEM_ARCHITECTURE.md)から始める
2. **API開発中の方** → [APIリファレンス](./API_REFERENCE.md)を参照
3. **データベース作業中の方** → [データベーススキーマ](./DATABASE_SCHEMA.md)を確認
4. **機能計画中の方** → [開発ロードマップ](./DEVELOPMENT_ROADMAP.md)をレビュー

### システム管理者向け

1. **データベースセキュリティ** → [RLS管理ガイド](./RLS_MANAGEMENT_GUIDE.md)を参照
2. **デプロイ情報** → [システムアーキテクチャ - デプロイメント](./SYSTEM_ARCHITECTURE.md#deployment-architecture)を確認
3. **パフォーマンスチューニング** → [データベーススキーマ - インデックス](./DATABASE_SCHEMA.md#indexes--performance)をレビュー

### プロジェクトマネージャー向け

1. **プロジェクトタイムライン** → [開発ロードマップ](./DEVELOPMENT_ROADMAP.md)をレビュー
2. **現在のステータス** → [開発ロードマップ - 現在のステータス](./DEVELOPMENT_ROADMAP.md#current-status)を参照
3. **予算計画** → [開発ロードマップ - 予算サマリー](./DEVELOPMENT_ROADMAP.md#budget-summary)を確認

## 🏗️ システム概要

### HAASとは？

HAAS（HKT Assign & Attendance System）は、HKT48劇場運営用に設計された包括的なスタッフ管理システムです。以下を管理します：

- **スタッフスキル**: PA、音源再生マニピュレーター、照明、バックステージ（4種類実装済み）
- **出退勤追跡**: QRコード認証付きGPSベースの位置確認
- **スケジュール管理**: 週次の利用可能性とシフト割り当て
- **コンプライアンス**: 日本の労働法準拠（週40時間、必須休憩時間）

### 技術スタック

```yaml
フロントエンド:
  - Next.js 14.2.7 (React 18)
  - TypeScript 5.5.4
  - Tailwind CSS 3.4.10

バックエンド:
  - Supabase (PostgreSQL 15+ with PostGIS)
  - Next.js API Routes
  - Edge Functions (Deno)

インフラストラクチャ:
  - Vercel (ホスティング & CDN)
  - GitHub (バージョン管理 & CI/CD)
  - Supabase Cloud (データベース & 認証)
```

## 📊 現在の実装状況

### ✅ 実装済み機能
- ユーザー認証（Supabase Auth）
- GPSベースの出退勤（±300m検証）
- QRコード機材スキャン
- 基本的なスタッフ管理
- 管理者ダッシュボード
- 本番環境デプロイ
- 4つのスキルタイプ（PA、音源再生マニピュレーター、照明、バックステージ）
- RLS無限再帰問題の修正（マイグレーション015-017）

### 🚧 開発中
- スタッフごとの複数スキル対応
- 週次スケジュール管理
- リザーブプールシステム
- 労働法コンプライアンスチェック

### 📋 計画中の機能
- 自動シフト割り当て
- LINE/Slack通知
- freee給与計算統合
- モバイルPWA
- 高度な分析機能

## 🔐 セキュリティとコンプライアンス

### 現在のセキュリティ対策
- JWTベースの認証
- Row Level Security (RLS) ポリシー（無限再帰修正済み）
- HMAC Webhook検証
- 環境変数の分離

### 既知の問題（MVP段階）
- すべてのテストユーザーが「password123」を使用 - **本番前に必ず修正**
- 簡素化されたRLSポリシー（再帰を避けるため）

### コンプライアンス要件
- 日本労働基準法準拠
- 週40時間制限
- 必須休憩時間（6時間：45分、8時間：60分）
- 週休制度要件

## 🔄 最近の更新

### 2025年9月22日
- RLS無限再帰問題を修正（マイグレーション015-017）
- 包括的なドキュメントスイートを作成
- ドキュメント構造を整理
- 全テストユーザーのパスワード動作確認

### 2025年9月20日
- スキルシステムの名称変更を実装（roles → skills）
- staff_schedulesテーブルを追加
- 廃止されたデータベーステーブルをクリーンアップ

### 2025年9月16日
- attendance_punch関数を追加
- JSTのタイムゾーン処理を実装

## 🛠️ 開発ガイドライン

### コード構成
```
hkt-assign-attendance-template/
├── app/                # Next.js App Router
│   ├── api/           # APIルート
│   ├── admin/         # 管理画面
│   ├── login/         # ログイン画面
│   ├── punch/         # 打刻画面
│   └── debug/         # デバッグツール
├── lib/               # ユーティリティとヘルパー
├── supabase/          # データベースマイグレーションと関数
│   └── migrations/    # SQLマイグレーションファイル
├── docs/              # このドキュメント
└── __tests__/         # テストスイート
```

### テスト戦略
- ユニットテスト: Jest
- E2Eテスト: Playwright
- APIモック: MSW
- 目標カバレッジ: 70%（現在約40%）

### Gitワークフロー
1. `main`からフィーチャーブランチを作成
2. PRレビュー必須
3. `main`へのマージで自動デプロイ
4. セマンティックバージョニング（v1.0.0）

## 📞 連絡先とサポート

### 開発チーム
- **本番環境**: https://haas-nu.vercel.app/
- **開発環境**: http://localhost:3000

### 問題報告
1. GitHubの既存の問題を確認
2. バグ/機能のためのissueテンプレートを使用
3. 再現手順を含める
4. 関連ログを添付

### ドキュメント更新
- ドキュメントは`/docs`フォルダに存在
- 機能変更に伴う更新が必要
- Markdown形式を使用
- 必要に応じて図を含める（Mermaidサポート）

## 📝 ドキュメント標準

### フォーマットガイドライン
- Markdown（.md）形式を使用
- 長いドキュメントには目次を含める
- 図にはMermaidを使用
- セクションを簡潔で焦点を絞った内容にする

### バージョン管理
- 「最終更新日」を更新
- 大きな変更にはドキュメントバージョンを増加
- マイグレーションノートに履歴コンテキストを保持

### レビュープロセス
1. 開発チームによる技術レビュー
2. 明確性レビュー（可能な場合）
3. 主要な変更に対するステークホルダーの承認

## 🎯 クイックリンク

### 外部リソース
- [Supabaseドキュメント](https://supabase.com/docs)
- [Next.jsドキュメント](https://nextjs.org/docs)
- [PostGISドキュメント](https://postgis.net/documentation/)
- [日本労働基準法](https://www.mhlw.go.jp/english/policy/employ-labour/labour-standards/)

### 内部リソース
- [CLAUDEプロジェクト指示](../CLAUDE.md)
- [テストレポート](../TEST_REPORT.md)
- [アーキテクチャ図](./SYSTEM_ARCHITECTURE.md#high-level-architecture-diagram)

---

**ドキュメントハブバージョン**: 1.0.0
**メンテナンス**: 開発チーム
**レビューサイクル**: 開発中は週次、メンテナンス中は月次
**次回レビュー**: 2025年10月1日