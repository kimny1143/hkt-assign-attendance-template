# データベース設計

## 概要

HAASシステムのPostgreSQL + PostGISデータベース設計書です。

## テーブル構成

### 📍 venues（会場）
GPS位置情報を持つ会場マスタ

| カラム名 | 型 | 説明 | 制約 |
|---------|---|------|-----|
| id | uuid | 主キー | PK, DEFAULT uuid_generate_v4() |
| name | text | 会場名 | NOT NULL |
| address | text | 住所 | |
| lat | float8 | 緯度 | NOT NULL |
| lon | float8 | 経度 | NOT NULL |
| location | geography(Point) | PostGIS位置情報 | |
| created_at | timestamptz | 作成日時 | DEFAULT now() |

**インデックス**
- `idx_venues_location` - GIST (location) - 位置検索用

---

### 📅 events（イベント）
会場で開催されるイベント

| カラム名 | 型 | 説明 | 制約 |
|---------|---|------|-----|
| id | uuid | 主キー | PK |
| name | text | イベント名 | NOT NULL |
| venue_id | uuid | 会場ID | FK → venues(id) |
| date | date | 開催日 | NOT NULL |
| created_at | timestamptz | 作成日時 | DEFAULT now() |

---

### 🕐 shifts（シフト）
イベントのシフト情報

| カラム名 | 型 | 説明 | 制約 |
|---------|---|------|-----|
| id | uuid | 主キー | PK |
| event_id | uuid | イベントID | FK → events(id) |
| start_at | timestamptz | 開始時刻 | NOT NULL |
| end_at | timestamptz | 終了時刻 | NOT NULL |
| pa_count | integer | PA必要人数 | DEFAULT 0 |
| audio_count | integer | 音源再生必要人数 | DEFAULT 0 |
| lighting_count | integer | 照明必要人数 | DEFAULT 0 |
| backstage_count | integer | バックヤード必要人数 | DEFAULT 0 |

**インデックス**
- `idx_shifts_start_at` - BTREEインデックス

---

### 👤 staff（スタッフ）
スタッフ情報と4スキル管理

| カラム名 | 型 | 説明 | 制約 |
|---------|---|------|-----|
| id | uuid | 主キー | PK |
| user_id | uuid | ユーザーID | FK → auth.users(id) |
| name | text | 氏名 | NOT NULL |
| phone | text | 電話番号 | |
| line_user_id | text | LINE ID | UNIQUE |
| skill_pa | boolean | PAスキル | DEFAULT false |
| skill_audio | boolean | 音源再生スキル | DEFAULT false |
| skill_lighting | boolean | 照明スキル | DEFAULT false |
| skill_backstage | boolean | バックヤードスキル | DEFAULT false |
| max_weekly_hours | integer | 週最大労働時間 | DEFAULT 40 |
| created_at | timestamptz | 作成日時 | DEFAULT now() |

---

### 📋 assignments（割り当て）
スタッフのシフト割り当て

| カラム名 | 型 | 説明 | 制約 |
|---------|---|------|-----|
| id | uuid | 主キー | PK |
| shift_id | uuid | シフトID | FK → shifts(id) |
| staff_id | uuid | スタッフID | FK → staff(id) |
| skill_type | text | 割り当てスキル | CHECK IN ('PA','音源再生','照明','バックヤード') |
| status | text | ステータス | DEFAULT 'pending' |
| confirmed_at | timestamptz | 確認日時 | |
| line_message_id | text | LINE通知ID | |
| created_at | timestamptz | 作成日時 | DEFAULT now() |

**ユニーク制約**
- `UNIQUE (shift_id, staff_id)` - 重複割り当て防止

---

### ✅ attendances（出退勤）
GPS検証付き出退勤記録

| カラム名 | 型 | 説明 | 制約 |
|---------|---|------|-----|
| id | uuid | 主キー | PK |
| shift_id | uuid | シフトID | FK → shifts(id) |
| staff_id | uuid | スタッフID | FK → staff(id) |
| check_in_at | timestamptz | 出勤時刻 | |
| check_in_gps | jsonb | 出勤GPS | {lat, lon, accuracy} |
| check_in_photo | text | 出勤写真パス | |
| check_out_at | timestamptz | 退勤時刻 | |
| check_out_gps | jsonb | 退勤GPS | {lat, lon, accuracy} |
| check_out_photo | text | 退勤写真パス | |
| created_at | timestamptz | 作成日時 | DEFAULT now() |

---

### 🔐 qr_tokens（QRトークン）
日次QRコード認証トークン

| カラム名 | 型 | 説明 | 制約 |
|---------|---|------|-----|
| id | uuid | 主キー | PK |
| token | text | トークン文字列 | UNIQUE, NOT NULL |
| shift_id | uuid | シフトID | FK → shifts(id) |
| purpose | text | 用途 | CHECK IN ('checkin','checkout') |
| issued_at | timestamptz | 発行日時 | DEFAULT now() |
| expires_at | timestamptz | 有効期限 | NOT NULL |
| used_at | timestamptz | 使用日時 | |
| used_by | uuid | 使用者 | FK → staff(id) |

---

### 🛠️ equipment（機材）
QRコード付き機材管理

| カラム名 | 型 | 説明 | 制約 |
|---------|---|------|-----|
| id | uuid | 主キー | PK |
| venue_id | uuid | 会場ID | FK → venues(id) |
| name | text | 機材名 | NOT NULL |
| qr_code | text | QRコード | UNIQUE, NOT NULL |
| active | boolean | 有効フラグ | DEFAULT true |
| created_at | timestamptz | 作成日時 | DEFAULT now() |

---

## ビュー

### v_payroll_monthly
月次給与計算用集計ビュー

```sql
CREATE VIEW v_payroll_monthly AS
SELECT
  s.id as staff_id,
  s.name as staff_name,
  DATE_TRUNC('month', a.check_in_at) as month,
  COUNT(DISTINCT DATE(a.check_in_at)) as work_days,
  SUM(EXTRACT(EPOCH FROM (a.check_out_at - a.check_in_at))/3600) as total_hours,
  COUNT(*) as shift_count
FROM attendances a
JOIN staff s ON a.staff_id = s.id
WHERE a.check_out_at IS NOT NULL
GROUP BY s.id, s.name, DATE_TRUNC('month', a.check_in_at);
```

---

## RLS（行レベルセキュリティ）ポリシー

### staff テーブル
- **自己参照**: ユーザーは自分のスタッフ情報のみ参照可能
- **管理者**: adminロールは全スタッフ参照可能

### attendances テーブル
- **自己記録**: スタッフは自分の出退勤記録のみ参照・作成可能
- **管理者**: 全記録の参照・編集可能

### assignments テーブル
- **自己割り当て**: スタッフは自分の割り当てのみ参照可能
- **管理者**: 全割り当ての作成・編集・削除可能

---

## ストアドプロシージャ

### attendance_punch
出退勤打刻処理（GPS検証付き）

```sql
CREATE OR REPLACE FUNCTION attendance_punch(
  p_staff_uid uuid,
  p_shift_id uuid,
  p_equipment_qr text,
  p_lat float8,
  p_lon float8,
  p_purpose text
) RETURNS jsonb AS $$
DECLARE
  v_staff_id uuid;
  v_venue_location geography;
  v_distance float;
BEGIN
  -- スタッフID取得
  SELECT id INTO v_staff_id FROM staff WHERE user_id = p_staff_uid;

  -- 会場位置取得
  SELECT v.location INTO v_venue_location
  FROM venues v
  JOIN equipment e ON e.venue_id = v.id
  WHERE e.qr_code = p_equipment_qr;

  -- GPS距離検証（300m以内）
  v_distance := ST_Distance(
    v_venue_location,
    ST_MakePoint(p_lon, p_lat)::geography
  );

  IF v_distance > 300 THEN
    RAISE EXCEPTION 'Too far from venue: %m', v_distance;
  END IF;

  -- 打刻記録作成/更新
  -- ...（実装詳細）
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

## インデックス戦略

### パフォーマンス最適化
1. **位置検索**: GISTインデックスでGPS検索を高速化
2. **日付検索**: BTREEインデックスでシフト検索を効率化
3. **ユニーク制約**: 重複データ防止とパフォーマンス向上

### 推奨インデックス
- `attendances(shift_id, staff_id)` - 出退勤検索
- `assignments(status, created_at)` - ステータス別検索
- `shifts(event_id, start_at)` - イベント別シフト検索