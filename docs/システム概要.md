# HAASシステム概要

## プロジェクト概要

HAAS（HKT Assign & Attendance System）は、イベントスタッフの割り当てと出退勤を管理するWebアプリケーションです。

## 主な機能

### 🎯 コア機能

#### 1. GPS位置検証付き出退勤
- 会場から**300m以内**でのみ打刻可能
- QRコードスキャン必須
- 写真撮影による本人確認
- PostGISによる高精度位置計算

#### 2. 4スキルシステム
スタッフの専門スキル管理：
- **PA**（音響）
- **音源再生**
- **照明**
- **バックヤード**

#### 3. LINE連携
- シフト確認通知
- CONFIRM/DECLINEによる承認
- リアルタイム通知配信

#### 4. 労働時間管理
- **週40時間制限**の自動チェック
- 月次勤怠集計
- freee連携用CSV出力

---

## 技術スタック

### フロントエンド
- **Next.js 14** (App Router)
- **TypeScript** - 型安全な開発
- **Tailwind CSS** - スタイリング
- **React QR Scanner** - QRコード読み取り

### バックエンド
- **Supabase** - BaaS基盤
  - PostgreSQL + PostGIS
  - 認証・認可
  - リアルタイムサブスクリプション
  - Edge Functions（Deno）

### API連携
- **LINE Messaging API** - 通知配信
- **Supabase Storage** - 写真保存

### 開発ツール
- **MCP (Model Context Protocol)** - AI支援開発
- **Playwright** - E2Eテスト
- **Jest** - ユニットテスト
- **GitHub Actions** - CI/CD

---

## プロジェクト構成

```
hkt-assign-attendance-template/
├── app/                    # Next.js App Router
│   ├── api/               # APIルート
│   │   ├── attendance/    # 出退勤API
│   │   ├── admin/         # 管理者API
│   │   └── line-webhook/  # LINE Webhook
│   ├── admin/             # 管理画面
│   └── punch/             # 打刻画面
├── components/            # Reactコンポーネント
├── lib/                   # ユーティリティ
│   ├── supabase/         # Supabase設定
│   └── utils/            # 共通関数
│       └── date.ts       # タイムゾーン処理
├── supabase/             # DB設定
│   ├── migrations/       # スキーマ定義
│   └── functions/        # Edge Functions
├── __tests__/            # テストコード
│   ├── unit/            # ユニットテスト
│   ├── integration/     # 統合テスト
│   └── e2e/             # E2Eテスト
└── scripts/              # 開発スクリプト
    └── mcp/             # MCPサーバー
```

---

## セキュリティ

### 認証・認可
- Supabase Auth による認証
- RLS（Row Level Security）によるデータアクセス制御
- Service Role Keyの厳密な管理

### データ検証
- Zodスキーマによる入力検証
- GPS位置の二重検証（クライアント・サーバー）
- HMAC署名によるWebhook検証

### 環境変数管理
```env
# Public（クライアント側で使用可能）
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=

# Secret（サーバー側のみ）
SUPABASE_SERVICE_ROLE_KEY=
LINE_CHANNEL_SECRET=
LINE_CHANNEL_ACCESS_TOKEN=
```

---

## 開発環境セットアップ

### 1. 依存関係インストール
```bash
npm install
```

### 2. 環境変数設定
```bash
cp .env.example .env.local
# .env.localを編集
```

### 3. Supabaseセットアップ
- Supabaseプロジェクト作成
- `supabase/migrations/schema.sql`を実行
- Storage bucket作成（`att-photos`）

### 4. 開発サーバー起動
```bash
npm run dev
```

---

## デプロイ

### Vercel推奨設定
- **Framework**: Next.js
- **Build Command**: `npm run build`
- **Environment Variables**: 本番用の値を設定

### CI/CD
GitHub ActionsによるCI/CDパイプライン：
1. コード品質チェック（lint, typecheck）
2. テスト実行（unit, integration）
3. ビルド検証
4. セキュリティスキャン（CodeQL）

---

## タイムゾーン処理

すべての日時処理は日本時間（JST）基準：
- データベース保存: UTC
- API通信: ISO 8601形式
- 表示: JST変換済み

詳細は[タイムゾーン実装ガイド](./タイムゾーン実装ガイド.md)参照

---

## 今後の拡張予定

1. **LIFF（LINE Front-end Framework）統合**
   - LINE内でのネイティブ体験
   - シームレスなログイン

2. **自動シフト割り当て**
   - スキルマッチング最適化
   - AIによる推奨

3. **分析ダッシュボード**
   - 勤怠統計
   - スタッフパフォーマンス指標

4. **多言語対応**
   - 英語サポート
   - 他言語への拡張

---

## ライセンス

Private - HKT内部使用のみ

## サポート

問い合わせ: [プロジェクト管理者]