---

# 報告書兼実装指示書

## 目的

MVP 実装において冗長な処理や二重管理を削減し、Postgres/PostGIS・Supabase の機能を最大限活用することで、**API 層を薄く、DB 層を厚く**する。これにより、保守性・性能・セキュリティを改善する。

---

## 1. 距離計算ロジックの整理

### 現状

* API 層で Haversine 公式を手計算。
* 毎回アプリケーションで緯度経度を解釈している。

### 問題

* バグの温床（精度・単位）。
* クエリ効率が悪い（全件取得 → 計算）。

### 指示

* PostGIS 関数 `ST_DWithin` を利用して DB 関数に統合。
* API は `select attendance_punch_v2(...)` を叩くだけにする。

---

## 2. 当日アサインメント取得の整理

### 現状

* `/api/assignments/today` が複数のテーブルを逐次クエリ。
* JS 内で日付処理をゴリゴリ実装。

### 問題

* API の複雑化。
* JST タイムゾーン処理が各所に散らばる。

### 指示

* DB に `today_assignments` ビューを作成。

  * `staff`, `shifts`, `assignments`, `events`, `venues` を結合。
  * `current_setting('TIMEZONE') = 'Asia/Tokyo'` に固定して JST フィルタ。
* API 層はビューを呼ぶだけに統一。

---

## 3. ミドルウェアと認可処理

### 現状

* 毎リクエストで DB 照会を走らせてユーザー権限確認。
* 全ルートでミドルウェアが走っている。

### 問題

* 不要なクエリで遅延。
* 権限管理が二重化。

### 指示

* ミドルウェアは `/admin/*` のみにマッチングさせる。
* 権限チェックは **Supabase Row Level Security (RLS)** に寄せる。
* ロール判定はログイン時の claims で埋め込み。

---

## 4. 日付・時間ユーティリティ

### 現状

* 独自 util フォルダに多数の関数。
* `formatDateJST`, `formatTime`, `getToday` などが重複。

### 問題

* 二重実装・複雑化。

### 指示

* `date-fns-tz` に一本化。
* 最小限：`formatTime` のみを util に残す。
* 他は直接 `date-fns-tz` を呼び出す。

---

## 5. LINE Webhook 検証

### 現状

* 独自の HMAC 検証コードを手書き。

### 問題

* バグリスク高。
* 公式ライブラリに劣る。

### 指示

* `@line/bot-sdk` の `validateSignature` を利用。
* 可能なら Supabase Edge Functions に移動し、サービスキーを安全に保持。

---

## 6. Supabase クライアント管理

### 現状

* API ルートごとに `createClient` を呼んでいる。

### 問題

* コード重複・設定漏れリスク。

### 指示

* `lib/supabaseClient.ts` を作り、全てそこから import。
* ミドルウェア・API とも共通利用。

---

## 7. 依存パッケージの整理

### 現状

* `react-qr-code` など用途不明のライブラリあり。
* テスト系パッケージが `dependencies` に残っている。

### 問題

* バンドルサイズ増加。
* セキュリティ更新コスト増。

### 指示

* QR「表示」だけなら残す、**スキャンのみなら削除**。
* Jest, Playwright 等は `devDependencies` に移動。

---

## 実装優先度

1. **距離計算のDB移行**（最もリスク削減効果大）。
2. **当日アサインメントビュー作成**（クエリ統合・API単純化）。
3. **ミドルウェア修正 & RLS徹底**。
4. **LINE SDK 導入 & Supabase Edge Functions 移行**。
5. **Supabase クライアント統合**。
6. **日付処理の一本化**。
7. **依存関係の整理**。

---

## まとめ

* **方針：API 層を薄くし、DB 層に集約。**
* **成果：保守性・性能・セキュリティが大幅に向上。**
* 実装 AI には、上記指示を順にタスク化して割り当てること。

---
